name: Update Course Images

on:
  # D√©clencher manuellement depuis GitHub
  workflow_dispatch:
  
  # D√©clencher automatiquement tous les jours √† 3h du matin UTC
  schedule:
    - cron: '0 3 * * *'
  
  # D√©clencher apr√®s chaque push sur main (optionnel - d√©commentez si besoin)
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'src/pages/Courses.jsx'
  #     - 'assign_category_images.sql'

jobs:
  update-images:
    runs-on: ubuntu-latest
    name: Update Course Images via Supabase
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Update course images via Supabase Edge Function
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "üîÑ Calling Supabase Edge Function to update course images..."
          
          response=$(curl -s -X POST \
            "$SUPABASE_URL/functions/v1/update-course-images" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            -H "Content-Type: application/json")
          
          echo "üìä Response: $response"
          
          # V√©rifier si la r√©ponse contient "success"
          if echo "$response" | grep -q '"success":true'; then
            echo "‚úÖ Course images updated successfully"
            exit 0
          else
            echo "‚ùå Failed to update course images"
            echo "$response"
            exit 1
          fi

      - name: Notify on success
        if: success()
        run: |
          echo "‚úÖ Course images updated successfully!"
          echo "You can add Slack/Discord notifications here if needed"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Failed to update course images"
          echo "Check the logs above for details"
